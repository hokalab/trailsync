# ヤマレコ→Runkeeper GPX変換設計書

## 1. 概要

このドキュメントでは、ヤマレコのGPXファイルをRunkeeper互換フォーマットに変換するための設計と実装アプローチを提案します。特に、複数日にわたるアクティビティデータの正確な変換に焦点を当てています。

## 2. 目的

ヤマレコで記録したGPXファイルをRunkeeper互換フォーマットに変換し、複数日にわたるアクティビティデータを正確に変換することを目的としています。

## 3. GPXファイル形式の比較

### 3.1 基本構造の比較

| 特徴 | Runkeeper | ヤマレコ | Strava |
|------|-----------|----------|--------|
| XML宣言 | あり | あり | あり |
| 名前空間 | 複数定義 | 基本のみ | 基本のみ |
| メタデータ要素 | なし | なし | あり |
| トラック名形式 | CDATA | プレーンテキスト | Unicodeエスケープ |
| 複数日対応 | 可能 | 可能 | 可能 |

### 3.2 トラックポイント要素の比較

| 特徴 | Runkeeper | ヤマレコ | Strava |
|------|-----------|----------|--------|
| 座標精度 | 6桁 | 6桁 | 7桁 |
| 標高データ | あり | あり | あり |
| タイムスタンプ | ISO 8601形式 | ISO 8601形式 | ISO 8601形式 |
| 拡張データ | 心拍数のみ | なし | 多数 |

### 3.3 メタデータの比較

| 特徴 | Runkeeper | ヤマレコ | Strava |
|------|-----------|----------|--------|
| 作成者情報 | あり | なし | あり |
| アクティビティタイプ | 明示的 | なし | 明示的 |
| 時間情報 | あり | あり | あり |
| リンク情報 | なし | なし | あり |

## 4. 変換の課題

### 4.1 複数日データの扱い

ヤマレコのGPXファイルには複数日のデータが含まれることがありますが、Runkeeperに直接インポートすると1日分のみが認識される問題があります。Stravaを経由することで複数日データが正しく認識されることが確認されています。

### 4.2 メタデータの追加

ヤマレコのGPXファイルにはメタデータセクションがありませんが、Runkeeperでの正確な認識のためにはメタデータの追加が必要です。

### 4.3 アクティビティタイプの指定

Runkeeperではアクティビティタイプの明示的な指定が必要ですが、ヤマレコのGPXファイルにはこの情報がありません。

## 5. 変換アプローチ

### 5.1 基本変換フロー

1. ヤマレコGPXファイルの解析
2. メタデータセクションの追加
3. アクティビティタイプの明示的な指定
4. トラックポイントの変換（座標精度の調整、標高データの調整）
5. Runkeeper互換GPXファイルの生成

### 5.2 改良版変換スクリプトの機能

- メタデータセクションの追加
- アクティビティタイプの明示的な指定
- XMLフォーマットの構造化オプション
- 座標精度の調整
- 標高データの調整
- 元のサービス情報の保持オプション

## 6. 実装計画

### 6.1 コマンドラインオプション

| オプション | 説明 | デフォルト値 |
|------------|------|--------------|
| `--activity-type` | アクティビティタイプ | hiking |
| `--track-name` | トラック名 | 日時から自動生成 |
| `--format-xml` | XMLを整形する（インデントを追加） | False |
| `--coordinate-precision` | 座標精度（小数点以下の桁数） | 6 |
| `--elevation-adjustment` | 標高調整値（メートル単位） | 5.2 |
| `--add-metadata` | メタデータセクションを追加する | True |
| `--keep-source` | 元のサービス情報を保持する | True |

### 6.2 テスト計画

1. 単一日のアクティビティデータの変換テスト
2. 複数日のアクティビティデータの変換テスト
3. 各コマンドラインオプションの動作確認テスト
4. Runkeeperへのインポートテスト

## 7. 将来の拡張

- ウェブインターフェースの追加
- バッチ処理機能
- 他のサービス（Garmin, Suunto等）への対応
- APIの提供

## 8. 技術スタック

- Python 3.11
- lxml 4.9.3
- pytest 7.4.2
- ruff 0.0.292